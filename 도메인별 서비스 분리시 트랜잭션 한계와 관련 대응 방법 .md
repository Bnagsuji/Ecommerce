## 도메인별 서비스 분리시 트랜잭션 한계와 관련 대응 방법

---

### 조건

##### Domain 분리
- 주문(Order)
- 상품/재고(Product)
- 결제(Account)
- 쿠폰(Coupon)

위와 같이 Domain과 각 DB를 분리시킨다.
다른 도메인의 데이터 필요 시 API, 이벤트로 교환한다.

---

### 1) **분리 시 트랜잭션 한계**

##### A. **원자성(A) 상실**
한 요청이 여러 서비스/DB를 건드리면 “모두 성공/모두 실패”를 한 번에 보장하기 어렵다. 2PC는 운영 복잡도와 가용성 저하로 일반적으로 지양.


##### **격리(I) 약화 / Read-your-writes 불가**
주문 직후 재고/결제 결과가 다른 서비스에 “즉시” 반영되지 않을 수 있다(최종 일관성).


##### **중복·순서 문제**
네트워크 재시도로 이벤트/요청이 중복 도착하거나 순서가 엇갈린다.

##### **장애 전파**
동기 체인 호출(주문→재고→결제)에서 한 서비스 다운 시 전체가 타임아웃. 서킷이 없으면 카스케이드 장애.

##### **글로벌 락 불가**
서비스 간 분산락으로 원자성을 흉내내면 확장성과 가용성 급락(데드락·스플릿브레인 리스크).


---

### **2) 대응 전략**

##### **A. Saga(보상 트랜잭션)**

- Choreography: 이벤트 기반(예: OrderPlaced → 재고 예약 성공/실패 → 결제 승인/거부 → 주문 완료/취소).

- Orchestration: 전용 오케스트레이터가 단계·타임아웃·보상 흐름을 관리.

_**설계 포인트: 각 단계는 로컬 트랜잭션으로 끝내고, 실패 시 보상 액션을 명시(재고 되돌림, 결제 취소 등).**_

##### **B. Outbox + CDC(트랜잭셔널 메시징)**

- 주문 저장과 이벤트 기록을 같은 DB 트랜잭션으로 커밋(outbox 테이블).

- Debezium 등 CDC가 Outbox를 읽어 Kafka/Redis Streams로 퍼블리시. 
➝ _DB커밋 후 이벤트 유실되는 것을 방지. 퍼블리셔 재시도 가능_


##### C. 멱등성(Idempotency) & 중복 방지

- 요청마다 idempotency key를 붙여 중복 실행을 막는다.

- 처리한 메시지는 기록해 두고, 같은 ID가 오면 무시.

##### D. 타임아웃·재시도·서킷브레이커

- 요청이 오래 걸리면 끊고, 필요하면 재시도.

- 실패가 반복되면 서킷브레이커로 차단.

- 계속 안 되면 DLQ(Dead Letter Queue)에 보내고 알림을 띄운다.

##### E. 조회 일관성: CQRS/리드모델/캐시

- “주문 + 상품명 + 쿠폰혜택” 같이 여러 도메인 데이터를 합쳐 보여줄 때는
조회 전용 테이블이나 Redis 같은 캐시를 둔다.

- 이벤트가 올 때마다 미리 갱신해 두고, 사용자에겐 “조금 늦을 수 있다”는 걸 전제로 제공한다.

##### F. 도메인 경계 원칙

- 데이터는 한 서비스만 변경할 수 있다.

- 다른 서비스는 API나 이벤트로만 접근.

##### G. TCC(try-confirm-cancel)

- 좌석 예매, 한정 수량 같은 자원에는 “예약 → 확정 → 취소” 단계를 나눠 관리.

- 구현이 복잡하니 꼭 필요한 곳에만 적용.

##### H. 관측성

- OpenTelemetry로 서비스 간 요청 흐름 추적.

- 퍼블리셔/컨슈머의 성능, 실패율을 모니터링하고 알림을 받는다.

**[프로젝트 간단 플로우]**

- Order 서비스: 주문 PENDING 저장 + Outbox에 OrderPlaced 기록(로컬 커밋)
- Product 서비스: OrderPlaced 수신 → 재고 예약 성공 시 StockReserved, 실패 시 StockRejected 발행
- Payment 서비스: StockReserved 수신 → 결제 시도 → PaymentApproved/Declined 발행
- Order 서비스: 승인 시 COMPLETED, 거부/재고실패 시 CANCELED(+보상 이벤트)

**[하지 말아야 할 것]**
- 공유 DB/교차 업데이트, 서비스 간 글로벌 락, 이벤트 스키마의 비호환 변경.
- 한 화면 그리려고 동기 체인 호출 다단계 구성(캐시/리드모델로 흡수).

--- 

### 결론

도메인 분리하면 더 이상 하나의 DB에서 ACID 트랜잭션으로 다 해결할 수 없고, 
최종적으로 데이터가 맞아 떨어지는 구조를 받아들여야 한다.
그래서 Saga, Outbox/CDC, 멱등 처리, 재시도·서킷브레이커·DLQ 같은 회복 장치, 그리고 CQRS 같은 패턴을 함께 적용해야 한다 .
결과적으로 서비스가 커져도 안정적이고 확장 가능한 시스템을 만들 수 있다.
