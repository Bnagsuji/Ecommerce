# 부하 테스트 결과 보고서

## 1. 테스트 개요
- **테스트 시나리오:** Order/Top-Selling
- **목적:** 주문/결제 및 인기상품 조회 핵심 비즈니스 기능의 성능 및 안정성 검증
- **가상 사용자 수:** 최대 302 VUs (예약 480 VUs)
- **테스트 실행 시간:** 약 3분 42초

---

## 2. 테스트 결과 요약
- 아래 그림은 k6 실행 결과를 Grafana 모니터링 활용 결과이다.
![1st_test_result.png](image%2F1st_test_result.png)

| 지표 | 전체 | top | detail | order | charge |
|------|------|-----|--------|-------|--------|
| p95 응답시간 | 2.52 s | 5.52 ms ✅ | 13.48 ms ✅ | 85.94 ms ✅ | 3.88 s ❌ |
| 평균 응답시간 | 266 ms | 3.83 ms | 11.42 ms | 50.03 ms | 2.18 s |
| 중간값(median) | 33.65 ms | 3.63 ms | 8.2 ms | 40.38 ms | 2.3 s |
| 최대 응답시간 | 7.07 s | 13.24 ms | 2.21 s | 2.92 s | 7.07 s |
| 상태코드 체크 | - | 200 ✅ | 200 ✅ | 200/400 99.92% | 200 ✅ |

- **총 요청 수 :** 9,462 (약 42.6 req/s)
- **에러율 :** 0.76% (임계치 2% 이하 → 요구사항 충족)
- **테스트 결과 :** 전반적으로 정상, 단 `charge` 엔드포인트 p95 3.88 s로 임계치(800 ms) 초과 → 쓰기 경로 병목 가능성 있음.

---

## 3. 성능 분석
1. **top/detail/order 엔드포인트** : 모두 p95 기준 내, 정상 동작
    - 인기상품 조회 및 주문 처리 경로는 충분히 빠른 응답 보장
2. **charge 엔드포인트** : p95 3.88 s → 임계치 800 ms 초과
    - 포인트 충전 경로의 동시성/DB 쓰기 병목 가능성 존재
    - 평균 응답시간 2.18 s, 최대 7.07 s → 일부 요청 지연 심각

---

## 4. 개선 방안

### 4.1 charge(포인트 충전) 성능
- **비동기 처리 고려 :** 요청 즉시 응답 후 백그라운드 처리
- **DB 성능 개선 :** 인덱스 최적화, 트랜잭션 분리, 배치 처리
- **락 경합 최소화 :** 비관적 락 → 낙관적 락 전환, row-level lock 활용
- **캐시 활용 :** 잔액 조회를 캐시로 먼저 확인 후 실제 DB 쓰기 수행
- **Queue/메시지 기반 처리 :** 높은 RPS 발생 시 메시지 큐로 부하 분산

### 4.2 인프라 조정
- **DB 커넥션 풀 확장 :** 최대 동시 쓰기 요청 대응
- **애플리케이션 스레드 확장 :** 고RPS 처리에 필요한 쓰레드 수 확보
- **로드밸런싱 :** 수평 확장 고려 (여러 인스턴스)

### 4.3 테스트 반복 및 검증
- charge 엔드포인트 개선 후 **재부하 테스트 수행**
- Ramp-up/Plateau 구조 유지하며 개선 전/후 p95 비교

---

## 5. 장애 대응 시나리오

### 5.1 charge 엔드포인트 지연
- **상황:** 포인트 충전 요청 p95 3.88 s 초과
- **대응:**
    1. 사용자에게 "충전 처리 중" 알림 표시
    2. 백그라운드 큐로 요청 이관 후 재시도 처리
    3. 실패 시 알람/로그 기록, 관리자가 확인 후 수동 처리 가능

### 5.2 DB 트랜잭션 실패
- **상황:** 동시에 다수 요청으로 DB deadlock 발생
- **대응:**
    1. 트랜잭션 재시도(Retry) 적용
    2. 실패율 모니터링 및 임계치 초과 시 자동 알람
    3. 중요 트랜잭션(포인트/주문) 분리 테이블 또는 파티셔닝 고려

### 5.3 주문/결제 비동기 처리 지연
- **상황:** 주문 완료 상태 확인 지연
- **대응:**
    1. 주문 상태 조회 재시도 로직 적용 (exponential backoff)
    2. 실패 시 사용자에게 알림 및 재시도 옵션 제공
    3. 백엔드 모니터링을 통해 비동기 처리 큐 상태 확인

---

## 6. 결론
- 인기상품 조회 및 주문/결제 경로는 안정적
- **포인트 충전(charge) 경로** 병목 존재 → 개선 필요
- 개선 후 재부하 테스트 및 모니터링을 통해 안정성 검증 필요
- 장애 대응 시나리오를 마련하여, 부하 증가나 트랜잭션 지연 시 즉시 대응 가능
